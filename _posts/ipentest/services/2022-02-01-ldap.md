---
title:  Ldap Pentesting
date: 2022-06-03 05:49:33 +0800
categories: [Infrastructure Pentesting, Ldap]
tags: [infrastructure, pentesting, services, ldap]     # TAG names should always be lowercase
---

# Ldap

The Lightweight Directory Access Protocol (LDAP) is a directory service protocol that runs on a layer above the TCP/IP stack. It provides a mechanism used to connect to, search, and modify Internet directories. It runs on port `389/tcp` by default.

# Enumeration

## Scanning With Nmap

We can use nmap to scan ldap protocol.

```bash

nmap -sT -sV -Pn -p 389 [target_host]

```

![ldap](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ldap0.png)

Above image shows ldap was running on port 389/tcp on our target. 

# Bruteforcing Ldap

## hydra

Using hydra , we can bruteforce credentials of ldap protocol.

```bash
hydra -l [username] -P [/path/to/password/wordlist] ldap2://[target_ip]
```

![ldap](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ldap1.png)


In the above image we were able to get a valid credential `krobot:kPassword@123`.

# Exploitation

## Dump all domain information

Since we got valid credentials, we can extract everything from our target domain using `ldapsearch`.

```bash

ldapsearch -x -D '[domain\username]' -w '[password]' -b 'dc=[subdomain],dc=[tld]' -H ldap://[target_ip]

```

![ldap](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ldap2.png)

![ldap](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ldap3.png)

## Extract Users .

```bash

ldapsearch -x -D '[domain\username]' -w '[password]' -b 'cn=users,dc=[subdomain],dc=[tld]' -H ldap://[target_ip]

```

![ldap](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ldap4.png)

## Extract Information Of A Specific User

```bash

ldapsearch -x -D '[domain\username]' -w '[password]' -b 'cn=[target_user],cn=users,dc=[subdomain],dc=[tld]' -H ldap://[target_ip]

```

![ldap](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ldap5.png)

## Extract Computers

```bash

ldapsearch -x -D '[domain\username]' -w '[password]' -b 'cn=computers,dc=[subdomain],dc=[tld]' -H ldap://[target_ip]

```

![ldap](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ldap6.png)

# Sniffing

The traffic sent to and received from ldap is not encrypted. We can leverage this to retrieve a clear-text credential.

## Wireshark

We can use wireshark to sniff ldap traffic.

![ldap](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ldap8.png)

Analysing ldap traffic revealed the clear-text credential of ldap

# References

- [https://docs.microsoft.com/en-us/previous-versions/windows/desktop/ldap/lightweight-directory-access-protocol-ldap-api](https://docs.microsoft.com/en-us/previous-versions/windows/desktop/ldap/lightweight-directory-access-protocol-ldap-api)
- [https://book.hacktricks.xyz/network-services-pentesting/pentesting-ldap](https://book.hacktricks.xyz/network-services-pentesting/pentesting-ldap)
