---
title:  Insecure Service-> Weak Registry Permissions
date: 2022-06-03 05:49:33 +0800
categories: [Infrastructure Pentesting, Windows Privilege Escalations]
tags: []  
---

# Insecure Service-> Weak Registry Permissions

If the registry entries of a service is `modifiable` by our user, and at thesame time we can `stop/start` the service , then we can achieve `Privilege Escalation` if the service runs with a `SYSTEM privileges` by modify the serviceâ€™s configuration in the registry.

# Enumeration

We are going to exploit insecure service to escalate our privileges to `SYSTEM`. Let's check our current user.

![winpriv](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvperm0.png)

Now, Let's execute `Get-Services` in powershell to get the list of available services.

![winpriv](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvreg1.png)

We will conduct an enumeration on `regsvc` service. We will use `Get-Acl` from powershell to check the registry's acl of the service.

![winpriv](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvreg3.png)

As you can see, we have Full Control, which means we can be able to modify the registry entries of the service.

Let's query the entries using `reg.exe`.

![winpriv](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvreg2.png)

Well...here our target is `ImagePath`, we are going to change it to point to the path of our own reverse shell executable. But before that, let's further examine the service to see whether or not the other conditions are satisfied...

To be able to exploit a service and escalate our privileges, we need to:

- `be able to start/stop the service`
- `have the service runs with higher privileges`

We are going to check the above conditions using `accesschk.exe` and `sc.exe`, if all the conditions are satisfied, we can achieve `privilege escalation`.

Let's execute `accesschk /accepteula -cqv user regsvc` .

![winpriv](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvreg6.png)

Well...As you can see, we have permission to start/stop the service.

We will execute `sc qc regsvc` to check whether or not the service runs with `SYSTEM` privilege.

![winpriv](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvreg5.png)

Nice!! It runs with SYSTEM privilege. All conditions are satisfied, so we are going to exploit the service.

# Exploitation

We are going replace the `imagepath` of the service with the path of our  own reverse shell executable. 

![winpriv](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvreg4.png)

Now, we will setup our reverse shell listener and start the service by executing `net start regsvc`.

![winpriv](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvreg7.png)

![winpriv](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvperm6.png)

Well...As you can see, we have obtained shell with `SYSTEM` privilege.

 
