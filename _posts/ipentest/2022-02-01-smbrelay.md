---
title: SMBRelay
date: 2022-06-03 05:49:33 +0800
categories: [Infrastructure Pentesting, Active Directory]
tags: []  
---

# SMBRelay

SMB signing is a security mechanism that allows digitally signing SMB packets to enforce their authenticity and integrity - the client/server knows that the incoming SMB packets they are receiving are coming from a trusted source and that they have not been tampered with while in transit, preventing man in the middle type attacks.

If SMB signing is disabled, packets can be intercepted/modified and/or relayed to another system.

# Exploitation

For SMBRelay to be successfull, three condition must be met :- 

- SMB signing must be disabled on our target machine.
- Relayed user credential must be admin on the target machine.

We will use nmap to scan for host with `SMB Signing disabled`.

![relay](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ntlmrelay1.png)

We will run `responder` with `HTTP` and `SMB` set to `OFF`.

![relay](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ntlmrelay2.png)

at the same time, we will run `smbrelayx.py` that will listen for smb request and relay them to our target system `10.42.0.30` and then execute "whoami /user" commands on the target.

![relay](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/smbrelaye2.png)

Now we will go back to the victim machine and access the share inwhich we placed our malicious file.

![relay](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/smbrelaye5.png)

Now let's go back to our machine .

![relay](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/smbrelaye4.png)

We have successfully executed command on our target system.


# References 

- [https://docs.microsoft.com/en-us/archive/blogs/josebda/the-basics-of-smb-signing-covering-both-smb1-and-smb2](https://docs.microsoft.com/en-us/archive/blogs/josebda/the-basics-of-smb-signing-covering-both-smb1-and-smb2)
- [https://www.ired.team/offensive-security/lateral-movement/lateral-movement-via-smb-relaying-by-abusing-lack-of-smb-signing](https://www.ired.team/offensive-security/lateral-movement/lateral-movement-via-smb-relaying-by-abusing-lack-of-smb-signing)
