---
title: Unconstrained delegation
date: 2022-06-03 05:49:33 +0800
categories: [Infrastructure Pentesting, Active Directory]
tags: []  
---

# Unconstrained delegation

This is a feature that a Domain Administrator can set to any Computer inside the domain. Then, anytime a user logins onto the Computer, a copy of the TGT of that user is going to be sent inside the TGS provided by the DC and saved in memory in LSASS. So, if you have Administrator privileges on the machine, you will be able to dump the tickets and impersonate the users on any machine. So if a domain admin logins inside a Computer with "Unconstrained Delegation" feature activated, and you have local admin privileges inside that machine, you will be able to dump the ticket and impersonate the Domain Admin anywhere (domain privesc).

# Enumeration

## Powerview

To execute an unconstrained delegation attack, we need to have administrative privilege on the machine. There multiple ways to check whether or not we have administrative privileges on the system, but here we will be using `Find-Localadminaccess` from `powerview`, which will check to see if we are local admin on the machine.

![uncd](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/uncd1.png)

As you can see, we were localadmin on `OPS.cyber.local`, which was the current machine.

Since we are localadmin on the machine, we will execute the below commands to determine whether or not the machine has unconstrained delegation enabled.

```powershell

get-netcomputer -unconstrained | select samaccountname

```
![uncd](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/uncd2.png)

# Exploitation

Before exploitation, let's try to get access to dc.

![uncd](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/uncd4.png)

Here, we couldn't access the dc because we didn't have the privileges.

We will execute `sekurlsa::tickets /export` in mimikatz and export the available TGTS.

![uncd](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/uncd5.png)

![uncd](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/uncd6.png)

As you can see we have exported the TGS but there was no ticket for `administrator`. 

Since we don't have TGT of administrator, we will wait unti the administrator authenticates to the machine so that his TGT gets cached.

For this purpose, we will login to domain controller and make administrator authenticates to the machine.

![uncd](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/uncd7.png)

We have made administrator to authenticate to the compromised machine. Now we will go back to the compromised machine and use mimikatz to export the TGT of the administrator.

![uncd](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/uncd8.png)

Nice!. We got TGT of the administrator.

With the TGT of the administrator retrieved, we will use mimikatz to pass the ticket and get access to dc.

![uncd](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/uncd9.png)

Now we can access the dc.

![uncd](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/uncd10.png)

# References

- [https://stealthbits.com/blog/unconstrained-delegation-permissions/](https://stealthbits.com/blog/unconstrained-delegation-permissions/)
- [https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/unconstrained-delegation](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/unconstrained-delegation)
