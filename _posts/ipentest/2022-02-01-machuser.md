---
title: Machine Account -> UserAccountControl
date: 2022-06-03 05:49:33 +0800
categories: [Infrastructure Pentesting, Active Directory]
tags: []  
---

# UserAccountControl

User-Account-Control Attribute Flags that control the behavior of the Microsoft Active Directory user account. It contains a range of flags which define some important basic properties of a user object. These flags can also be used to request or change the status of an account.

SERVER_TRUST_ACCOUNT is a User-Account-Control flag that makes computer account to appear as domain controller. It has hexadecimal value of `0x2000`.

The trick here is that, we will modify the flag of `useraccountcontrol` attribute to have `SERVER_TRUST_ACCOUNT`, This will turn the machine to domain controller allowing us to execute dcsync attack on the domain and retrieve user's credential. This is possible because any machine account with `SERVER_TRUST_ACCOUNT` flag set will have the `Replications` right.

Note: `This is a domain persistence technigue, therefore, assume we have compromised domain administrator's account and we are trying to achieve persistence in the domain.`

# Exploitation

Since we have compromised administrator account, we will abuse `UserAccountControl` attribute to achieve `domain persistence`.
 
To do that, we will create a new machine account using `powermad`

```powershell

new-machineaccount -machineaccount backdoor -domain cyber.local -domaincontroller dc01.cyber.local

```
![ma](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/machineaccount1.png)

![ma](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/machineaccount2.png)

As you can see, we have created new machine `backdoor`.

We will check the `UserAccountControl` attribute to see the flag assigned to it.

![ma](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/machineaccount3.png)

Here the value of useraccountcontrol was `WORKSTATION_TRUST_ACCOUNT`. Therefore, we are going to change the flag to `SERVER_TRUST_ACCOUNT` which will turn the machine to domain controller, thereby giving it `Replications right` which will allow us to execute `dcsync attack` and retrive user's credential whenever we want.

![ma](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/machineaccount5.png)

![ma](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/machineaccount4.png)

As you can see, the useraccountcontrol has been changed to `SERVER_TRUST_ACCOUNT`.

To execute dcsync attack, we will login to our newly created machine account `backdoor`.

```powershell
runas /netonly /user:cyber.local\backdoor$ cmd.exe

```
![ma](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/machineaccount7.png)

Now we will load mimikatz and execute `lsadump::dcsync /user:krbtgt` to retrieve credential of `krbtgt` account.

![ma](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/machineaccount8.png)

Done. 

# References

- [https://ldapwiki.com/wiki/User-Account-Control%20Attribute](https://ldapwiki.com/wiki/User-Account-Control%20Attribute)
- [https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties)
