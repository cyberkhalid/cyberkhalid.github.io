---
title: Server-Side Template Injection
date: 2022-01-01 05:49:33 +0800
categories: [WebApp And Api Pentesting, Server-Side Template Injection]
tags: [] 
---

# Server-Side Template Injection(SSTI)

 Server Side Template Injection vulnerabilities (SSTI) occur when user input is embedded in a template in an unsafe manner and results in remote code execution on the server
 
# Detection

![ssti](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ssti1.png)

The webapp takes a profile name from the url and then displays it on the page with a welcoming text. Let's try changing the profile name to `exploit` and see what will happen. 

![ssti](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ssti2.png)

As you can see, we got a welcoming message with our profile name displayed.

Let's fuzz the url to see if we can break something and get an error, or if we can determine some anomality. There are lot of characters that can be used such as `{ } ; , || ' @ / > < $`....

![ssti](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ssti3.png)

By supplying `{` `{` `<`, we got an internal server error message. We might be thinking of server-side template engine running in the backend as they are used for dynamic rendering and also they mostly use `{ }` characters in their syntax. Let's test for server-side template injection.

We will supply this payload `{2*2}` , if we get `22` or `4` as the profile name, then it's vulnerable to ssti, otherwise we will proceed with another payload as most server-side templating engine has different syntax.

![ssti](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ssti4.png)

As you can see, this was unsuccessfull, Therefore We will proceed with another payload to see what will happen. We will supply `{ { 2*2 } }`.

![ssti](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ssti5.png)

Well, We got `4` as the profile name, which means it's vulnerable to ssti.

# Identification

Since there are lot of server-side templating engine, we need to identify the server-side template engine in use so we can exploit it. The fact that server-side template engines interpret input differently will allow us to distinguish one from another. We will use the below image to determine our engine.


![engine](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/sstiengine.png)

By using the above image, since we successfully executed `{ { 2*2 } }`, our engine will be either jinja2 or twig . Let's supply `{ { 5*'3' } }` to see what will happen


![ssti](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ssti7.png)

As you can see, we got `33333`. this means our engine is jinja2.

Let's test for jinja2 by supplying `{ { config } }`

![ssti](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ssti8.png)

Great!,Our payload was successfull, therefore, we have finally determine our engine which is jinja2.

# Exploitation

We can supply the below payload to execute shell command.

```bash
{ { ''.__class__.__mro__[1].__subclasses__()[401]("whoami", shell=True, stdout=-1).communicate() } }

```

![ssti](https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/ssti11.png)

We have executed shell command.


# References

- [https://owasp.org/www-project-web-security-testing-guide/v41/4-Web_Application_Security_Testing/07-Input_Validation_Testing/18-Testing_for_Server_Side_Template_Injection](https://owasp.org/www-project-web-security-testing-guide/v41/4-Web_Application_Security_Testing/07-Input_Validation_Testing/18-Testing_for_Server_Side_Template_Injection)
