<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Insecure Service-&gt; Unquoted Service Path" /><meta property="og:locale" content="en" /><meta name="description" content="Insecure Service-&gt; Unquoted Service Path" /><meta property="og:description" content="Insecure Service-&gt; Unquoted Service Path" /><link rel="canonical" href="https://cyberkhalid.github.io/posts/winprivsrvunq/" /><meta property="og:url" content="https://cyberkhalid.github.io/posts/winprivsrvunq/" /><meta property="og:site_name" content="cyberkhalid" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-03T05:49:33+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Insecure Service-&gt; Unquoted Service Path" /><meta name="twitter:site" content="@_cyberkhalid" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-07T19:28:46+08:00","datePublished":"2022-06-03T05:49:33+08:00","description":"Insecure Service-&gt; Unquoted Service Path","headline":"Insecure Service-&gt; Unquoted Service Path","mainEntityOfPage":{"@type":"WebPage","@id":"https://cyberkhalid.github.io/posts/winprivsrvunq/"},"url":"https://cyberkhalid.github.io/posts/winprivsrvunq/"}</script><title>Insecure Service-> Unquoted Service Path | cyberkhalid</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="cyberkhalid"><meta name="application-name" content="cyberkhalid"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" https://raw.githubusercontent.com/cyberkhalid/cyberkhalid/main/cyberl.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">cyberkhalid</a></div><div class="site-subtitle font-italic">Offensive Security || Red Team || Pentester || • 0xCyb3rkh4l1d •</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/cyberkhalid" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_cyberkhalid" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['root','cyberkhalid.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Insecure Service-> Unquoted Service Path</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Insecure Service-> Unquoted Service Path</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/0xcyb3rkh4l1d">cyberkhalid</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1654206573" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-06-03 </em> </span> <span> Updated <em class="timeago" data-ts="1662550126" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-09-07 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="472 words"> <em>2 min</em> read</span></div></div></div><div class="post-content"><h1 id="insecure-service--unquoted-service-path">Insecure Service-&gt; Unquoted Service Path</h1><p>Executables in Windows can be run without using their extension (e.g. “whoami.exe” can be run by just typing “whoami”). Some executables take arguments, separated by spaces, e.g. someprog.exe arg1 arg2 arg3….This behavior leads to ambiguity when using absolute paths that are unquoted and contain spaces. The Windows must assume where to find the referenced application if the path contains spaces and is not enclosed by quotation marks. If, for example, a service uses the unquoted path:</p><p>Vulnerable Service: C:\Program Files\Ignite Data\Vuln Service\file.exe</p><p>The system will read this path in the following sequence from 1 to 4 to trigger malicous.exe through a writeable directory.</p><ul><li><p><code class="language-plaintext highlighter-rouge">C:\Program.exe</code></p><li><p><code class="language-plaintext highlighter-rouge">C:\Program Files\Ignite.exe</code></p><li><p><code class="language-plaintext highlighter-rouge">C:\Program Files\Ignite Data\Vuln.exe</code></p><li><p><code class="language-plaintext highlighter-rouge">C:\Program Files\Ignite Data\Vuln Service\file.exe</code></p></ul><p>If the path to the service binary is <code class="language-plaintext highlighter-rouge">not enclosed in quotes and contains white spaces</code>, and at thesame time we can <code class="language-plaintext highlighter-rouge">stop/start</code> the service , then we can achieve <code class="language-plaintext highlighter-rouge">Privilege Escalation</code> if the service runs with a <code class="language-plaintext highlighter-rouge">SYSTEM privileges</code> by simply placing our reverse shell executable in the writable path.</p><h1 id="enumeration">Enumeration</h1><p>We are going to exploit insecure service to escalate our privileges to <code class="language-plaintext highlighter-rouge">SYSTEM</code>. Let’s check our current user.</p><p><img data-src="https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvperm0.png" alt="winpriv" data-proofer-ignore></p><p>Now, We will be using <code class="language-plaintext highlighter-rouge">powerup.ps1</code> script to conduct an enumeration on the available services. Let’s import <code class="language-plaintext highlighter-rouge">powerup.ps1</code> and execute <code class="language-plaintext highlighter-rouge">Get-ServiceUnquoted</code> to get the list of services that are vulnerable.</p><p><img data-src="https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvun1.png" alt="winpriv" data-proofer-ignore></p><p>As you can see, <code class="language-plaintext highlighter-rouge">unquotedsvc</code> is vulnerable to Unquoted Service Path, which means we can be able to abuse the path and place our reverse shell executable, which will be executed when the service starts.</p><p>Let’s examine the path with <code class="language-plaintext highlighter-rouge">Get-Acl</code> to determine which directory we have write permission so that to place our reverse shell executable.</p><p><img data-src="https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvun4.png" alt="winpriv" data-proofer-ignore></p><p>Oh..It looks like we don’t have write permission on this directory. Let’s move to the next one.</p><p><img data-src="https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvun5.png" alt="winpriv" data-proofer-ignore></p><p>Great!…We have <code class="language-plaintext highlighter-rouge">Full Control</code> on this directory. We will place our reverse shell executable in this directory. But before that, let’s further examine the service to see whether or not the other conditions are satisfied…</p><p>To be able to exploit a service and escalate our privileges, we need to:</p><ul><li><code class="language-plaintext highlighter-rouge">be able to start/stop the service</code><li><code class="language-plaintext highlighter-rouge">have the service runs with higher privileges</code></ul><p>We are going to check the above conditions using <code class="language-plaintext highlighter-rouge">accesschk.exe</code> and <code class="language-plaintext highlighter-rouge">sc.exe</code>, if all the conditions are satisfied, we can achieve <code class="language-plaintext highlighter-rouge">privilege escalation</code>.</p><p>Let’s execute <code class="language-plaintext highlighter-rouge">accesschk /accepteula -cqv user unquotedsvc</code> .</p><p><img data-src="https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvun2.png" alt="winpriv" data-proofer-ignore></p><p>Well…As you can see, we have permission to start/stop the service.</p><p>We will execute <code class="language-plaintext highlighter-rouge">sc qc unquotedsvc</code> to check whether or not the service runs with <code class="language-plaintext highlighter-rouge">SYSTEM</code> privilege.</p><p><img data-src="https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvun3.png" alt="winpriv" data-proofer-ignore></p><p>Nice!! It runs with SYSTEM privilege. All conditions are satisfied, so we are going to exploit the service.</p><h1 id="exploitation">Exploitation</h1><p>We are going place our reverse shell executable in the writable path.</p><p><img data-src="https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvun6.png" alt="winpriv" data-proofer-ignore></p><p>Now, we will setup our reverse shell listener and start the service by executing <code class="language-plaintext highlighter-rouge">net start unquotedsvc</code>.</p><p><img data-src="https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvfile5.png" alt="winpriv" data-proofer-ignore></p><p><img data-src="https://raw.githubusercontent.com/cyberkhalid/cyberkhalid.github.io/main/assets/img/ipentest/winprivsrvperm6.png" alt="winpriv" data-proofer-ignore></p><p>Well…As you can see, we have obtained shell with <code class="language-plaintext highlighter-rouge">SYSTEM</code> privilege.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/infrastructure-pentesting/'>Infrastructure Pentesting</a>, <a href='/categories/windows-privilege-escalations/'>Windows Privilege Escalations</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Insecure Service-&gt; Unquoted Service Path - cyberkhalid&amp;url=https://cyberkhalid.github.io/posts/winprivsrvunq/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Insecure Service-&gt; Unquoted Service Path - cyberkhalid&amp;u=https://cyberkhalid.github.io/posts/winprivsrvunq/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://cyberkhalid.github.io/posts/winprivsrvunq/&amp;text=Insecure Service-&gt; Unquoted Service Path - cyberkhalid" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/pcron/">Cronjob</a><li><a href="/posts/autorun/">Registry Autoruns</a><li><a href="/posts/pwautorun/">Registry Autoruns</a><li><a href="/posts/pwstartup/">Startups</a><li><a href="/posts/winprivsrvunq/">Insecure Service-> Unquoted Service Path</a></ul></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/allwaysinstallelevated/"><div class="card-body"> <em class="timeago small" data-ts="1654206573" > 2022-06-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Registry — AlwaysInstallElevated</h3><div class="text-muted small"><p> Registry — AlwaysInstallElevated MSI files are package files used to install applications. These files run with the permissions of the user trying to install them. Windows allows for these install...</p></div></div></a></div><div class="card"> <a href="/posts/autorun/"><div class="card-body"> <em class="timeago small" data-ts="1654206573" > 2022-06-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Registry Autoruns</h3><div class="text-muted small"><p> Registry Autoruns Windows can be configured to run commands at startup, with elevated privileges. These AutoRuns are configured in the Registry. If you are able to write to an AutoRun executable, ...</p></div></div></a></div><div class="card"> <a href="/posts/printspooler/"><div class="card-body"> <em class="timeago small" data-ts="1654206573" > 2022-06-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Token Impersonation — PrintSpoofer</h3><div class="text-muted small"><p> Token Impersonation — PrintSpoofer For this exploit to work, we need local service or network service access and with SeImpersonatePrivilege or SeAssignPrimaryTokenPrivilege enabled. Enumeration ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/winprivsrvreg/" class="btn btn-outline-primary" prompt="Older"><p>Insecure Service-> Weak Registry Permissions</p></a> <a href="/posts/aclgroupaddself/" class="btn btn-outline-primary" prompt="Newer"><p>Self-Membership</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/0xcyb3rkh4l1d">cyberkhalid</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
